const TelegramBot = require('node-telegram-bot-api');
const fetch = require('node-fetch');
const fs = require('fs-extra');
const download = require('download-file');

// replace the value below with the Telegram token you receive from @BotFather
const token = '709253254:AAF2wXSv_gLq4Vch8cUrOugvp0wisuLqrsM';



// 709253254:AAF2wXSv_gLq4Vch8cUrOugvp0wisuLqrsM

// Create a bot that uses 'polling' to fetch new updates
const bot = new TelegramBot(token, {polling: true,});
// filepath: false,
bot.sendMessage(-276583637, "–ë–æ—Ç Indy –∑–∞—Ä–∞–±–æ—Ç–∞–ª!");
let positiveRating = [ ];
let negativeRating = [ ];
let rightConditions = [ "+", "—Å–ø–∞—Å–∏–±–æ", "—Å–ø—Å", "üëç", "üëå", "–æ–∫", "ok" ];
let wrongConditions = [ "-", "–Ω–µ—Ç", "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ", "üëé", "‚úñÔ∏è", "–Ω–µ", "‚úñ", "–Ω–µ –ø–æ–º–æ–≥–ª–æ" ];





// const token = '725276890:AAFZsqsDgLvLfhgY8t-9lhjhCN-ZwAazqUM';
// bot.sendMessage(-276583637, "–ö—Ç–æ –µ—â—ë –∫–æ–≥–æ –≤–∑–ª–∞–º–∞–µ—Ç, –ø–∏–¥—Ä–∏–ª–∞!");

const usersVoted = { };

const historyOpinions = [ ];
// var questions = [{
//     title: '–ö—Ç–æ –Ω–∞–∂–∞–ª –Ω–∞ —ç—Ç—É –∫–Ω–æ–ø–∫—É?',
//     buttons: [
//         [{
//             text: '–£–∑–Ω–∞–π, –∫—Ç–æ –∫–ª–∏–∫–Ω—É–ª',
//             callback_data: '1'
//         }]
//     ]
// }];
//
// function newQuestion() {
//     var arr = questions[0];
//     var text = arr.title;   //–≤–æ–ø—Ä–æ—Å –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π
//     var options = {
//         reply_markup: JSON.stringify({
//             inline_keyboard: arr.buttons
//         })
//     };
//     // bot.sendMessage(375240230, text, options);   //–º–æ–π ID
//     bot.sendMessage(-276583637, text, options);
//
//     bot.on('callback_query', msg => {
//         // console.log(msg);
//         bot.editMessageText(msg.message.text + '\n' + msg.from.first_name,  {
//             chat_id: msg.message.chat.id,    //–∏–ª–∏ -276583637
//             message_id: msg.message.message_id
//         })
//     });
//     // })
// }
//
// newQuestion();





bot.onText(/.+/, function(msg, match) {
     // console.log(msg)
    pushInArray(msg);

});


function canUserVote (user, date) {
    if (!usersVoted[user]) {
            console.log("–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª");
            return true
    } else {
        if (usersVoted[user].lastMessage + 1 < date) {
            console.log("–í—ã —Å–º–æ–≥–ª–∏ –µ—â–µ —Ä–∞–∑ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å");
            return true
        } else {
            console.log("–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –µ—â—ë –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å", usersVoted[user].lastMessage + 1 - date, "—Å–µ–∫—É–Ω–¥");
            return false
        }
    }
}


function pushInArray(msg) {
    const userId = msg.from.id;
    if (
        msg.reply_to_message &&
        ( userId !== msg.reply_to_message.from.id ) &&
        msg.reply_to_message.from.is_bot === false &&
        canUserVote (userId, msg.date)
    ) {
        const msgLowerText = msg.text.trim().toLowerCase();
        let message = {
            userName : msg.from.first_name,
            userFamily : msg.from.last_name,
            userId : userId,
            replyUser : msg.reply_to_message.from.id,
            replyUserName: msg.reply_to_message.from.first_name,
            comment : msg.reply_to_message.text,
            time : msg.date,
            textMessage : msg.text
        };
         if (rightConditions.includes(msgLowerText)) {
             message.review = "–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π";
             message.raiting = "+";
             historyOpinions.push(message);
             console.log(historyOpinions);
             console.log("–î–æ–±–∞–≤–ª–µ–Ω –≤ +", msg.reply_to_message.from.first_name);
             positiveRating.push(message.replyUser); // –±—ã–ª–æ msg.reply_to_message.from.first_name
             usersVoted[userId] = {
                 lastMessage : msg.date
             };
              console.log(usersVoted);
         } else if (wrongConditions.includes(msgLowerText)) {
             message.review = "–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π";
             message.raiting = "-";
             historyOpinions.push(message);
             console.log(historyOpinions);
             console.log("–î–æ–±–∞–≤–ª–µ–Ω –≤ -", msg.reply_to_message.from.first_name);
             negativeRating.push(message.replyUser);  // –±—ã–ª–æ msg.reply_to_message.from.first_name
             usersVoted[userId] = {
                 lastMessage : msg.date
             };
             console.log(usersVoted);
         }
    }
}


// negativeRating.push(msg.reply_to_message.from.id);  // –±—ã–ª–æ first_name

function countPlus(positiveRating, negativeRating) {
    let finalRating = {};
    for (let i = 0; i < positiveRating.length; i++) {
        if (finalRating[positiveRating[i]] === undefined) {
            finalRating[positiveRating[i]] = 1;
        } else {
            finalRating[positiveRating[i]]++;
        }
    }
    for (let j = 0; j < negativeRating.length; j++) {
        if (finalRating[negativeRating[j]] === undefined) {
            finalRating[negativeRating[j]] = -1;
        } else {
            finalRating[negativeRating[j]]--;
        }
    }
     // console.log("–°—É–º–º–∞",finalRating);
    return finalRating
}

function seekNameByID(id) {
    for (let i = 0; i < historyOpinions.length; i++) {
        if (historyOpinions[i].replyUser == id) {
            return historyOpinions[i].replyUserName
        }
    }
    return  null
}




bot.onText(/\/start/, function ratingShow(msg) {
    // console.log("–ö–æ–º–∞–Ω–¥–∞ —Å—Ç–∞—Ä—Ç —Å—Ä–∞–±–æ—Ç–∞–ª–∞")
    let sumObject =countPlus(positiveRating, negativeRating);   // –ø–æ–ª—É—á–∞–µ—Ç—Å—è { '311805730': 1, '375240230': -1 }
    let result = [];
    for (let id in sumObject) {
        result.push({
            id: id,
            sum: sumObject[id]
        });
    }                                           // –ø–æ–ª—É—á–∞–µ—Ç—Å—è  [ { id: '311805730', sum: 1 }, { id: '375240230', sum: -1 } ]
    result.sort(function(a, b) {
        return b.sum - a.sum;
    });
    // console.log("–ö–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç", result);
    let message ="";
    //console.log('historyOpinions',historyOpinions)
    for (let i = 0; i < result.length; i++) {
        const id = result[i].id;
        const userName = seekNameByID(id);
        message += i+1 +' –º–µ—Å—Ç–æ '+ userName + ":  " + result[i].sum +  " –≥–æ–ª–æ—Å–∞ \n";
    }
    // console.log( message);
    bot.sendMessage(msg.chat.id, message)
});


bot.onText(/\/history/, function ratingShow(msg) {
    let dateSeconds = new Date().getTime()/1000;
    let message ="–ú–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ –≤–∞—Å: \n";
    for (let i = 0; i < historyOpinions.length; i++) {
        if (historyOpinions[i].userId !== msg.from.id) {
            let time = Math.round(dateSeconds - historyOpinions[i].time);
            if (time>60)  time = Math.floor((dateSeconds - historyOpinions[i].time)/60) + " –º–∏–Ω—É—Ç—ã –∏ " + Math.round(dateSeconds - historyOpinions[i].time-60*Math.floor((dateSeconds - historyOpinions[i].time)/60))
            message +=
                // i+1 +' –º–Ω–µ–Ω–∏–µ ' +'\n'+
                historyOpinions[i].review + " –æ—Ç–∑—ã–≤ –æ—Å—Ç–∞–≤–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å " + historyOpinions[i].userName + " " +historyOpinions[i].userFamily + "" +
                " –ø–æ–¥ –≤–∞—à–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º '" + historyOpinions[i].comment + "'" + " " + time + " —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥ \n";
        }
    }
    if (message ==="–ú–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ –≤–∞—Å: \n") message += "–í–∞—Å –Ω–∏–≥–¥–µ –Ω–µ —É–ø–æ–º—è–Ω–∞–ª–∏.";
    // console.log( message);
    bot.sendMessage(msg.chat.id, message)
});


bot.onText(/\/status/, function ratingShow(msg) {
    let message ="–í–∞—à —Å—Ç–∞—Ç—É—Å: \n";
    let status = 0;
    for (let i = 0; i < historyOpinions.length; i++) {
        if (historyOpinions[i].replyUser === msg.from.id )
            if (historyOpinions[i].raiting === "+")
                status ++;
        else status --;
    }
    message = checkStatus(status);
    // console.log( message);
    bot.sendMessage(msg.chat.id, message)
});

const arrayStatus = [
    {
        lt: -1,
        value: '–í —à–∞–≥–µ –æ—Ç –±–∞–Ω–∞ ' + " –º–µ–Ω—å—à–µ -1 –≥–æ–ª–æ—Å–∞"
    }, {
        eq: -1,
        value: '–¢—ã –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω? ' + "-1 –≥–æ–ª–æ—Å"
    }, {
        eq: 0,
        value: '–¢—ã –∫—Ç–æ —Ç–∞–∫–æ–π? ' + "0 –≥–æ–ª–æ—Å–æ–≤"
    }, {
        eq: 1,
        value: '–ö—Ç–æ-—Ç–æ –ø–æ –æ—à–∏–±–∫–µ –Ω–∞–∂–∞–ª –∏ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª –∑–∞ —Ç–µ–±—è ' + "1 –≥–æ–ª–æ—Å"
    }, {
        eq: 2,
        value: '–î–≤–∞ —á–µ–ª–æ–≤–µ–∫–∞ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–æ –∑–∞ —Ç–µ–±—è \n –Ω–∞–≤–µ—Ä–Ω–æ, –ø–æ–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ ' + "2 –≥–æ–ª–æ—Å–∞"
    }, {
        eq: 3,
        value:  "–ù–æ—Ä–º " + "3 –≥–æ–ª–æ—Å–∞"
    }, {
        gt: 3,
        value: "–í—ã –ø–æ–ø—É–ª—è—Ä–Ω—ã, –∞–¥–º–∏–Ω –¥–æ–≤–æ–ª–µ–Ω –≤–∞–º–∏" + " –±–æ–ª–µ–µ 3 –≥–æ–ª–æ—Å–æ–≤ "
    },
];


function checkStatus(raiting){
    for(let item of arrayStatus){
        if(item.hasOwnProperty('eq') && item.eq === raiting){
            return item.value
        }
        if (item.hasOwnProperty('lt') && raiting < item.lt){
            return item.value
        }
        if (item.hasOwnProperty('gt') && raiting > item.gt){
            return item.value
        }

    }
    return '–ö–∞–∫ —Ç—ã —Å–ª–æ–º–∞–ª –∑–¥–µ—Å—å –≤—Å–µ!?'
}


bot.onText(/\/download (.+)/, function ratingShow(msg, match) {
     const chatId = msg.chat.id;
    const urlDownload = match[1];
    const folder = "C:\\Users\\User\\Desktop\\–†–∞–±–æ—Ç–∞\\telegram_bot vers 4\\downloaded files"
    console.log(1)
   downloadFile(urlDownload, folder, chatId)
       .then(()=>{
            console.log('–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª—Å—è')
        })


});

// async
function downloadFile(linkDownload, linkStored, chat) {
    let lengthPath = fs.readdirSync(linkStored).length;
    console.log("–§–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ", lengthPath);
    const url = linkDownload;
    let options = {
        directory: linkStored,
        // filename: "–§–∞–π–ª " + Number(lengthPath + 1)
        filename: "–í–∞—à —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª"
    };
    return downloadPromise(url, options).then(fullPath=> {
        console.log("–ó–¥–µ—Å—å —É–∂–µ —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∫–∞—á–∞–Ω");
        // let fullPath = linkStored + "\\–í–∞—à —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª";
        console.log(fullPath);
        return bot.sendDocument(chat, fullPath);
    })
}



function downloadPromise(directory, options, chat) {
  return new Promise(function(resolve, reject) {
      download(directory, options, function(err, data ) {
      if (err) reject(err);
      else {
        console.log("–°–∫–∞—á–∞–Ω —Ñ–∞–π–ª");
          console.log("–ü—É—Ç—å", data);
         resolve(data);
      }
    });
  });
}

// 1 –æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ htttp –∑–∞–≥–æ–ª–æ–≤–∫–∞
// 2- –æ–µ reply + file


// http express
// json –º–∞—Å—Å–∏–≤–∞